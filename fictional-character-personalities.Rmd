---
title: "fictional-character-personalities"
author: "Alex Cookson"
date: "31/07/2020"
output: html_document
---

```{r setup, message = FALSE, warning = FALSE}
library(tidyverse)
library(tidymodels)
library(tidytext)

# Change this to GitHub link before publishing
personalities <- read_tsv("~/data/fictional-character-personalities/personalities.txt")
```

```{r eda}
personalities %>%
  mutate(spectrum_name = paste(spectrum_low, spectrum_high, sep = "_")) %>%
  select(character_code, spectrum_name, mean) %>%
  pivot_wider(names_from = spectrum_name, values_from = mean, values_fill = NA)
```

```{r helper-datasets}
character_list <- personalities %>%
  distinct(character_code, fictional_work, character_name)

spectrum_list <- personalities %>%
  distinct(spectrum, spectrum_low, spectrum_high)

interesting_works <- c("Arrested Development", "Anna Karenina", "Brooklyn Nine-Nine", "Star Trek: Deep Space Nine", "Friends",
                       "Game of Thrones", "The Good Place", "Harry Potter", "The Lion King", "Mad Men", "Parks and Recreation",
                       "Seinfeld", "Silicon Valley", "Star Wars", "Star Trek: The Next Generation")
```



### Worf's character evolution

Is Worf rated differently between TNG and DS9?

```{r worf-difference}
personalities %>%
  filter(character_name == "Worf",
         !is_emoji) %>%
  select(-character_code, -ratings, -sd, -is_emoji) %>%
  pivot_wider(names_from = fictional_work, values_from = mean) %>%
  rename(ds9 = `Star Trek: Deep Space Nine`,
         tng = `Star Trek: The Next Generation`) %>%
  mutate(change = ds9 - tng) %>%
  top_n(20, abs(change)) %>%
  arrange(desc(change))
```



### Use `tidymodels` to implement Principal Component Analysis (PCA)

Resources for PCA:

- `tidymodels` documentation: https://recipes.tidymodels.org/reference/step_pca.html
- Julia Silge's walkthrough: https://juliasilge.com/blog/best-hip-hop/

```{r data-for-pca}
pca_data <- personalities %>%
  filter(!is_emoji) %>%
  select(character_code, spectrum, mean) %>%
  pivot_wider(names_from = spectrum, values_from = mean)
```

```{r initial-pca}
# Write recipe for PCA
pca_recipe <- recipe(~ ., data = pca_data) %>%
  update_role(character_code, new_role = "id") %>%
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors())

# Inspect a few principal components to see what they capture
prep(pca_recipe) %>%
  tidy(type = "coef", number = 2) %>%
  left_join(spectrum_list, by = c("terms" = "spectrum")) %>%
  mutate(label = ifelse(value > 0, spectrum_high, spectrum_low),
         abs_value = abs(value)) %>%
  filter(component %in% paste0("PC", 1:9)) %>%
  group_by(component) %>%
  top_n(12, abs_value) %>%
  ungroup() %>%
  mutate(label = reorder_within(label, by = abs_value, within = component, sep = "_")) %>%
  ggplot(aes(abs_value, label)) +
  geom_col() +
  facet_wrap(~ component, scales = "free_y")

# Inspect PCA to see which principal components account for what % of variance
prep(pca_recipe) %>%
  tidy(type = "variance", number = 2) %>%
  filter(terms == "cumulative percent variance") %>%
  mutate(pct_variance = value / 100) %>%
  ggplot(aes(component, pct_variance)) +
  geom_line() +
  scale_y_continuous(labels = label_percent())
```

```{r second-pca}
# Add threshold to PCA to cover 90% of variance
pca_recipe <- recipe(~ ., data = pca_data) %>%
  update_role(character_code, new_role = "id") %>%
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors(),
           threshold = 0.9)

# Run PCA
personality_pca <- prep(pca_recipe) %>%
  juice()
```

```{r}
character_list %>%
  left_join(personality_pca, by = "character_code") %>%
  ggplot(aes(PC01, PC02)) +
  geom_text(aes(label = character_name), check_overlap = TRUE)
```


### STILL NEEDS WORK

Clustering rough code

```{r clustering}
clustering_data <- juice(pca_estimates) %>%
  select(PC1:PC6)

tibble(k = 1:20) %>%
  mutate(model = map(k, ~ kmeans(clustering_data, .x)),
         glanced_model = map(model, glance)) %>%
  unnest(cols = c(glanced_model)) %>%
  ggplot(aes(k, tot.withinss)) +
  geom_point() +
  geom_line()

kmeans(clustering_data, centers = 11) %>%
  augment(clustering_data) %>%
  bind_cols(juice(pca_estimates) %>% select(character_code, fictional_work, character_name)) %>%
  rename(cluster = .cluster) %>%
  select(character_code:character_name,
         cluster,
         PC1:PC6) %>%
  #filter(fictional_work %in% interesting_works) %>%
  View()
```










