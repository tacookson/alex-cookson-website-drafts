---
title: "fictional-character-personalities"
author: "Alex Cookson"
date: "31/07/2020"
output: html_document
---

```{r setup, message = FALSE, warning = FALSE}
library(tidyverse)

# Change this to GitHub link before publishing
personalities <- read_tsv("~/data/fictional-character-personalities/personalities.txt")
```

```{r eda}
personalities %>%
  mutate(spectrum_name = paste(spectrum_low, spectrum_high, sep = "_")) %>%
  select(character_code, spectrum_name, mean) %>%
  pivot_wider(names_from = spectrum_name, values_from = mean, values_fill = NA)
```

```{r random-spectrum-top-characters}
personalities %>%
  filter(spectrum == sample(unique(spectrum), 1)) %>%
  top_n(16, wt = mean) %>%
  mutate(fictional_work = fct_reorder(paste(character_name, fictional_work, sep = " | "), mean),
         label = paste(spectrum_low, spectrum_high, sep = " / ")) %>%
  ggplot(aes(mean, fictional_work)) +
  geom_point(size = 3) +
  geom_text(aes(label = label),
            hjust = 1,
            nudge_x = -1)
```


### Use `tidymodels` to implement Principal Component Analysis (PCA)

Resources for PCA:

- `tidymodels` documentation: https://recipes.tidymodels.org/reference/step_pca.html
- Julia Silge's walkthrough: https://juliasilge.com/blog/best-hip-hop/

```{r calculate-pca}
library(tidymodels)

personalities_df <- personalities %>%
  filter(!is_emoji) %>%
  group_by(character_code, fictional_work, character_name, spectrum_high) %>%
  summarise(mean = mean(mean)) %>%
  ungroup() %>%
  pivot_wider(names_from = "spectrum_high", values_from = "mean")

pca_trans <- recipe(~ ., data = personalities_df) %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric()) %>%
  step_pca(all_numeric(), num_comp = 6)

pca_estimates <- prep(pca_trans, training = personalities_df)

pca_data <- bake(pca_estimates, personalities_df)
```

```{r}
library(tidytext)

tidy(pca_estimates, number = 3) %>%
  filter(component %in% paste0("PC", 1:9)) %>%
  group_by(component) %>%
  top_n(12, abs(value)) %>%
  ungroup() %>%
  mutate(terms = reorder_within(terms, by = value, within = component, sep = "_")) %>%
  ggplot(aes(value, terms)) +
  geom_col() +
  scale_y_reordered() +
  facet_wrap(~ component, scales = "free_y")
```

```{r}
tidy(pca_estimates, number = 3) %>%
  filter(component %in% paste0("PC", 1:6)) %>%
  group_by(component) %>%
  top_n(12, abs(value)) %>%
  ungroup() %>%
  mutate(terms = reorder_within(terms, value, component, sep = "_")) %>%
  ggplot(aes(value, terms, fill = as.factor(sign(value)))) +
  geom_col() +
  facet_wrap(~ component, scales= "free_y")
```

```{r}
interesting_works <- c("Arrested Development", "Anna Karenina", "Brooklyn Nine-Nine", "Star Trek: Deep Space Nine", "Friends",
                       "Game of Thrones", "The Good Place", "Harry Potter", "The Lion King", "Mad Men", "Parks and Recreation",
                       "Seinfeld", "Silicon Valley", "Star Wars", "Star Trek: The Next Generation")

juice(pca_estimates) %>%
  filter(fictional_work %in% sample(interesting_works, 4)) %>%
  rename(`Chaotic -> Sensible` = PC1,
         `Hard -> Soft` = PC2) %>%
  ggplot(aes(`Chaotic -> Sensible`, `Hard -> Soft`)) +
  geom_text(aes(label = paste0(character_name, "\n(", fictional_work, ")")),
            size = 3, check_overlap = TRUE) +
  theme_light()
```

```{r}
tidy(pca_estimates, number = 3, type = "variance") %>%
  filter(terms == "percent variance") %>%
  transmute(component,
            pct_variance_explained = value / 100) %>%
  filter(pct_variance_explained > 0.005) %>%
  ggplot() +
  geom_col(aes(component, pct_variance_explained)) +
  scale_y_continuous(labels = label_percent())
```

```{r}
clustering_data <- juice(pca_estimates) %>%
  select(PC1:PC6)

tibble(k = 1:20) %>%
  mutate(model = map(k, ~ kmeans(clustering_data, .x)),
         glanced_model = map(model, glance)) %>%
  unnest(cols = c(glanced_model)) %>%
  ggplot(aes(k, tot.withinss)) +
  geom_point() +
  geom_line()

kmeans(clustering_data, centers = 11) %>%
  augment(clustering_data) %>%
  bind_cols(juice(pca_estimates) %>% select(character_code, fictional_work, character_name)) %>%
  rename(cluster = .cluster) %>%
  select(character_code:character_name,
         cluster,
         PC1:PC6) %>%
  #filter(fictional_work %in% interesting_works) %>%
  View()
```










