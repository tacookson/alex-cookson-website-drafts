---
title: "Empirical Bayes Estimation"
author: "Alex Cookson"
date: "31/05/2020"
output: html_document
---

Introduction. Children's books ratings with breakdown of 1-5 stars:

1. Recommend / Don't recommend
2. Star rating inference with shrinkage


## Setup

```{r setup-and-import}
library(tidyverse)
library(scales)
library(stats4)
library(broom)

theme_set(theme_light())

books <- read_tsv("https://raw.githubusercontent.com/tacookson/data/master/childrens-book-ratings/childrens-books.txt") %>%
  mutate(
    rating_count = rating_5 + rating_4 + rating_3 + rating_2 + rating_1,
    recommend = rating_5 + rating_4,
    dont_recommend = rating_3 + rating_2 + rating_1,
    # rec_index = recommendation index (% of people who recommend this book)
    rec_index = recommend / (recommend + dont_recommend),
    avg_rec_index = mean(rec_index, na.rm = TRUE)
  )
```



## Data inspection

```{r eda}
books %>%
  filter(rating_count > 2000) %>%
  ggplot(aes(rec_index)) +
  geom_histogram(binwidth = 0.02)
```

```{r}
books_recommend <- books %>%
  filter(rating_count > 2000)

books %>%
  ggplot(aes(rating_count, rec_index)) +
  geom_point(alpha = 0.2) +
  geom_hline(aes(yintercept = avg_rec_index), col = "red") +
  scale_x_log10(labels = label_comma())
```

```{r log-likelihood}
ll <- function(alpha, beta) {
  x <- books_recommend$recommend
  total <- books_recommend$rating_count
  -sum(VGAM::dbetabinom.ab(x, total, alpha, beta, log = TRUE))
}
```

```{r mle}
m <- mle(ll, start = list(alpha = 1, beta = 1), method = "L-BFGS-B", lower = c(0.0001, 0.0001))

ab <- coef(m)

alpha0 <- ab[1]
beta0 <- ab[2]
```

```{r beta-graph}
trials <- 1e6

simulations <- tibble(sample = rbeta(trials, alpha0, beta0))

simulations %>%
  ggplot(aes(sample)) +
  geom_density()

books_recommend %>%
  ggplot(aes(rec_index)) +
  geom_density(fill = "grey50", alpha = 0.3) +
  geom_density(data = simulations, aes(sample), col = "red", size = 2)
```

```{r credible-intervals}
books_recommend_shrunk <- books %>%
  select(-rating_5:-rating_1) %>%
  mutate(rec_index_estimate = (recommend + alpha0) / (rating_count + alpha0 + beta0))

books_recommend_shrunk %>%
  ggplot(aes(rating_count, rec_index)) +
  geom_point(alpha = 0.2) +
  geom_hline(aes(yintercept = avg_rec_index), col = "red") +
  scale_x_log10(labels = label_comma())
```

```{r}
books_recommend_shrunk %>%
  ggplot(aes(rating_count, rec_index_estimate)) +
  geom_point(alpha = 0.2) +
  geom_hline(aes(yintercept = avg_rec_index), col = "red") +
  scale_x_log10(labels = label_comma())
```

```{r}
books %>%
  mutate_at(vars(rating_5:rating_1), ~ . / rating_count) %>%
  filter(rating_count > 500) %>%
  ggplot(aes(rating_1)) +
  geom_histogram()
```

```{r dirichlet}
rating_matrix <- books %>%
  filter(rating_count > 0) %>%
  select(rating_5:rating_1) %>%
  as.matrix()

dm_fit <- DirichletMultinomial::dmn(rating_matrix, 1)

tidy.DMN <- function(x, ...) {
  ret <- as.data.frame(x@fit)
  as_tibble(fix_data_frame(ret, c("conf.low", "estimate", "conf.high")))
}

dm_params <- tidy(dm_fit)

par_total <- sum(dm_params$estimate)
par <- dm_params %>%
  select(term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate)

# Look up seemingly incorrect values for books with 100,000s of ratings
books %>%
  mutate(rating_calc = (rating_5 * 5 + rating_4 * 4 + rating_3 * 3 + rating_2 * 2 + rating_1 * 1) / (rating_count),
         rating_5_eb = rating_5 + par$rating_5,
         rating_4_eb = rating_4 + par$rating_4,
         rating_3_eb = rating_3 + par$rating_3,
         rating_2_eb = rating_2 + par$rating_2,
         rating_1_eb = rating_1 + par$rating_1,
         rating_eb = (rating_5_eb * 5 + rating_4_eb * 4 + rating_3_eb * 3 + rating_2_eb * 2 + rating_1_eb * 1) / (rating_count + par_total)) %>%
  select(title, rating, rating_calc, rating_eb)
```

```{r}
rating_pct <- books %>%
  filter(rating_count > 0) %>%
  mutate_at(vars(rating_5:rating_1), ~ . / rating_count) %>%
  select(-recommend:-avg_rec_index)

rating_pct %>%
  filter(rating_count > 500) %>%
  pivot_longer(cols = rating_5:rating_1) %>%
  ggplot(aes(value)) +
  geom_histogram(binwidth = 0.02) +
  facet_wrap(~ name)
```















## Other

Things to consider:

- Shrinking towards a prior distribution
- Adding regression to account for other factors (e.g., author, number of pages, year published)
- Normalizing: many reviews fall in a narrow band, so is there a way to get a more useful rating without having to consider most books falling between 3.9 to 4.2