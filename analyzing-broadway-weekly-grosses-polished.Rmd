---
title: Analyzing Broadway weekly grosses
author: Alex Cookson
date: '2020-04-19'
slug: analyzing-broadway-weekly-grosses
categories: []
tags: ["data exploration", "data cleaning", "time series data"]
description: ''
topics: []
---  
\  

INTRODUCTORY TEXT.

Questions to ask:

- What is the most successful Broadway show?
- How have ticket prices changed over time?


## Setup

Load packages and import data

```{r setup-and-import, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(scales)
library(fishualize)
library(extrafont)

theme_set(theme_light())

# Adding guess_max = 10000 show readr gets the column specifications right
grosses_raw <- readr::read_csv("https://raw.githubusercontent.com/tacookson/data/master/broadway-grosses/grosses.csv",
                            guess_max = 10000)
cpi_raw <- readr::read_csv("https://raw.githubusercontent.com/tacookson/data/master/broadway-grosses/cpi.csv")
```


## Data inspection

```{r inspect-grosses}
glimpse(grosses_raw)
```

```{r inspect-cpi}
glimpse(cpi_raw)
```


### Data cleaning

Cleaning grosses data:

- Zeros for weeks when there were no performances (should be NA)
- Top ticket prices for weeks with no performances (should be NA)
- Zeros for, e.g., weekly gross and seats sold, during weeks that there were performances (missing data from source)

```{r implicit-missing-values}
grosses_fixed_missing <- grosses_raw %>%
  # Find weeks where shows weren't performing
  mutate(no_shows = performances + previews == 0) %>%
  # Turn metrics into missing values if there were no shows
  # OR if metrics have a value of zero
  # (Likely missing data from the source)
  mutate_at(vars(weekly_gross:pct_capacity), ~ ifelse(no_shows | . == 0, NA, .)) %>%
  arrange(theatre, week_ending) %>%
  # Fill seats_in_theatre based on last known value
  fill(seats_in_theatre, .direction = "down") %>%
  # Get back into chronological order
  arrange(week_ending, show) %>%
  # Get rid of no_shows helper variable
  select(-no_shows)
```


Creating week of show variable

```{r fix-run-weeks-1}
grosses_clean_temp <- grosses_fixed_missing %>%
  group_by(show) %>%
  mutate(run_number = cumsum(row_number() == 1 |
                               week_ending - lag(week_ending) >= 90)) %>%
  group_by(show, run_number) %>%
  mutate(week_of_run = row_number()) %>%
  ungroup()
```

```{r fix-run-weeks-2}
pre_1985_starts <- readr::read_csv("https://raw.githubusercontent.com/tacookson/data/master/broadway-grosses/pre-1985-starts.csv")

calculate_weeks_since_start <- function(x) {
  as.integer(pmax(1, difftime("1985-06-09", x, units = "weeks")))
}

pre_1985_starts_calculated <- grosses_clean_temp %>%
  group_by(show, run_number) %>%
  filter(min(week_ending) == "1985-06-09") %>%
  ungroup() %>%
  select(week_ending, show) %>%
  left_join(pre_1985_starts, by = "show") %>%
  group_by(show) %>%
  mutate(week_of_run_originals = calculate_weeks_since_start(start_date) + row_number()) %>%
  ungroup() %>%
  select(week_ending, show, week_of_run_originals)

grosses_clean <- grosses_clean_temp %>%
  left_join(pre_1985_starts_calculated, by = c("show", "week_ending")) %>%
  mutate(week_of_run = coalesce(week_of_run_originals, week_of_run)) %>%
  select(-week_of_run_originals)
```


### Money

Cleaning CPI inflation data

```{r cpi-index-jan-2020}
cpi <- cpi_raw %>%
  mutate(jan_2020_dollars = cpi[year_month == "2020-01-01"] / cpi)
```


Adjusting dollar amounts to be in Jan 2020 dollars

```{r grosses-2020-dollars}
real_grosses <- grosses_clean %>%
  mutate(year_month = floor_date(week_ending, unit = "month")) %>%
  left_join(cpi, by = "year_month") %>%
  mutate_at(
    vars(
      weekly_gross_overall,
      weekly_gross,
      potential_gross,
      avg_ticket_price,
      top_ticket_price
    ),
    ~ . * jan_2020_dollars
  ) %>%
  select(-year_month:-jan_2020_dollars)
```


Cumulative gross over week of run

```{r cumulative-gross, warning = FALSE, message = FALSE, fig.align = 'center', fig.width = 12, fig.asp = 0.618}
cumulative_grosses_by_year <- real_grosses %>%
  mutate(show_and_run = paste0(show, " (Run ", run_number, ")"),
         year_of_run = week_of_run / 52) %>%
  group_by(show_and_run) %>%
  mutate(
    weekly_gross = coalesce(weekly_gross, 0),
    cumulative_gross = cumsum(weekly_gross)
  ) %>%
  ungroup() %>%
  group_by(show_and_run) %>%
  mutate(show_label = ifelse(
    year_of_run == max(year_of_run),
    paste0(" ", show),
    NA_character_
  )) %>%
  ungroup() %>%
  mutate(show_and_run = fct_reorder(show_and_run, year_of_run, .fun = max))

top_10_grossing <- cumulative_grosses_by_year %>%
  group_by(show_and_run) %>%
  summarise(show_total_gross = sum(weekly_gross)) %>%
  ungroup() %>%
  top_n(10, wt = show_total_gross) %>%
  pull(show_and_run)

cumulative_grosses_by_year %>%
  filter(show_and_run %in% top_10_grossing) %>%
  ggplot(aes(year_of_run, cumulative_gross, col = show_and_run)) +
  geom_line(size = 0.5) +
  geom_label(
    aes(label = show_label),
    size = 3,
    family = "Bahnschrift",
    fontface = "bold",
    hjust = 0,
    vjust = 0,
    label.size = NA,
    label.padding = unit(0.01, "lines"),
    label.r = unit(0.5, "lines")
  ) +
  scale_x_continuous(breaks = seq(0, 40, 5)) +
  scale_y_continuous(labels = label_dollar(scale = 1 / 1e6, suffix = "M")) +
  scale_colour_fish(option = "Epibulus_insidiator",
                    discrete = TRUE,
                    direction = 1) +
  expand_limits(x = 40) +
  labs(
    title = "Could Hamilton overtake The Lion King in...20 years?",
    subtitle = paste0("Cumulative box office receipts (Jan. 2020 dollars) for top 10 grossing shows since 1985"),
    caption = paste0("Source: Playbill\n",
                     "Note: Partial data for Cats, which started in 1982 (this data begins in 1985)"),
    x = "Year of run",
    y = ""
  ) +
  theme(
    legend.position = "none",
    text = element_text(family = "Bahnschrift"),
    panel.grid.minor = element_blank()
  )
```


Visualize progression of average top ticket prices

```{r top-ticket-prices}
top_tickets <- grosses_clean %>%
  mutate(year = year(week_ending)) %>%
  filter(year >= 1996,
         !is.na(top_ticket_price)) %>%
  group_by(year, show) %>%
  summarise(avg_ticket_price = mean(avg_ticket_price, na.rm = TRUE),
            avg_top_ticket_price = mean(top_ticket_price, na.rm = TRUE)) %>%
  mutate(annotated = (show == "The Producers" & between(year, 2002, 2003)) | show == "Manilow on Broadway") %>%
  ungroup() %>%
  mutate(is_hamilton = show == "Hamilton")

avg_top_tickets_by_year <- top_tickets %>%
  group_by(year) %>%
  summarise(avg_top_ticket_price = mean(avg_top_ticket_price))
  
top_tickets %>%
  ggplot(aes(year, avg_top_ticket_price)) +
  geom_jitter(data = top_tickets %>% filter(!annotated, !is_hamilton),
              position = position_jitter(width = 0.2),
              shape = 19,
              size = 2,
              col = "grey80",
              alpha = 0.5) +
  geom_point(data = top_tickets %>% filter(annotated),
             size = 2,
             col = "black") +
  geom_point(data = top_tickets %>% filter(is_hamilton),
             col = "#fc9d26",
             size = 4) +
  geom_line(data = avg_top_tickets_by_year,
            size = 1,
            col = "darkblue") +
  scale_x_continuous(breaks = seq(1996, 2020, 2)) +
  scale_y_continuous(breaks = seq(0, 1000, 100),
                     labels = dollar_format()) +
  annotate("text", x = 2018.5, y = 880, label = "Hamilton", col = "#fc9d26") +
  annotate("curve", x = 2011, y = 660, xend = 2012.95, yend = 695, curvature = 0.3, arrow = arrow(length = unit(2, "mm"))) +
  annotate("text", x = 2010.9, y = 665, label = "Manilow on Broadway", hjust = "right") +
  annotate("curve", x = 2003.5, y = 540, xend = 2002.05, yend = 485, curvature = 0.3, arrow = arrow(length = unit(2, "mm"))) +
  annotate("curve", x = 2003.5, y = 540, xend = 2003, yend = 485, curvature = 0.3, arrow = arrow(length = unit(2, "mm"))) +
  annotate("text", x = 2003.5, y = 540, label = "The Producers", hjust = "left") +
  labs(title = "A premium Broadway experience has become much pricier",
       subtitle = "(Especially if you're seeing Hamilton) Points show the average top ticket price for each show, by year",
       x = "",
       y = "") +
  theme(panel.grid.minor = element_blank())
```


Visualize progression of average average ticket prices

In 1985, the average Broadway ticket cost \$65. In 2020 (so far), it was \$119.

```{r avg-ticket-prices}
avg_tickets <- real_grosses %>%
  mutate(year = year(week_ending)) %>%
  filter(!is.na(avg_ticket_price)) %>%
  group_by(year, show) %>%
  summarise(avg_ticket_price = mean(avg_ticket_price, na.rm = TRUE),
            performances = sum(performances)) %>%
  ungroup()

avg_tickets_by_year <- avg_tickets %>%
  group_by(year) %>%
  summarise(avg_ticket_price = weighted.mean(avg_ticket_price, w = performances))
  
avg_tickets %>%
  ggplot(aes(year, avg_ticket_price)) +
  geom_jitter(position = position_jitter(width = 0.2),
              shape = 19,
              size = 2,
              col = "grey80",
              alpha = 0.5) +
  geom_line(data = avg_tickets_by_year,
            size = 1,
            col = "darkblue") +
  scale_y_continuous(labels = dollar_format()) +
  labs(title = "The cost of a Broadway experience has doubled in the past 35 years",
       subtitle = "Inflation-adjusted average ticket prices (Jan. 2020 dollars)",
       x = "",
       y = "") +
  theme(panel.grid.minor = element_blank())
```