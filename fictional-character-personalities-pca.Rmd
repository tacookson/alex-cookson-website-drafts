---
title: "fictional-character-personalities"
author: "Alex Cookson"
date: "11/11/2020"
output: html_document
---

### Introduction

- PCA, dimensionality reduction
- Overview of data


### The Data

```{r setup, message = FALSE, warning = FALSE}
library(tidyverse) # For data manipulation
library(tidymodels) # For PCA
library(tidytext) # For reorder_within()
library(extrafont) # For custom fonts on graphs

# These are to make tables look nice on the website
# You probably won't need them
library(knitr)
library(kableExtra)

theme_set(theme_void())

personalities_raw <- read_tsv("~/data/fictional-character-personalities/personalities.txt")

genders <- read_csv("https://raw.githubusercontent.com/tacookson/data/master/fictional-character-personalities/ref/character-gender.csv")

personalities <- personalities_raw %>%
  left_join(genders)
```

### Data Inspection

Let's look at an example character: Captain Jean-Luc Picard from *Star Trek: The Next Generation*.

```{r picard-example, fig.align = 'center', fig.width = 8}
personalities %>%
  filter(character_name == "Jean-Luc Picard") %>%
  head(8) %>%
  arrange(mean) %>%
  kable(format = "html") %>%
  kable_styling()
```

The main fields we're interested in are `spectrum_low`, `spectrum_high`, and `mean`:

- The spectrum fields tell us what trait is on each end of the spectrum being considered
- `mean` is a score (from -50 to +50), where a score closer to -50 means the character is more like the `spectrum_low` trait and a score closer to +50 means the character is more like the `spectrum_high` trait

If we look at some of Captain Picard's strongest traits -- that is, close to -50 or +50 -- we see that he is **charming** and **intellectual** (low scores corresponding to `spectrum_low`), as well as **bold** and **tasteful** (high scores corresponding to `spectrum_high`). That rings true to me. I would certainly use those words to describe our dear Captain.

Most of the other fields are to identify who the character is and what fictional world they come from. We also have the number of ratings (`ratings`) and standard deviation (`sd`) for that character-spectrum combination. And finally, we have a helper column, `is_emoji` that tells us if the traits on each end of the spectrum are emojis instead of words.  
\  

Juuuust to make sure this data checks out -- and because I'm really curious -- let's look at some more examples from *Pride and Prejudice* and *The Lion King*. We'll look each character's eight strongest traits.  
\  


#### *Pride and Prejudice*

```{r pride-and-prejudice-example, fig.align = 'center', fig.width = 12, fig.height = 6.75}
pride_palette <- c("#19313b", "#3b636b", "#bbb6a2",
                    "#ffc277", "#bc652f", "#472411")

pride_example <- personalities %>%
  filter(!is_emoji,
         fictional_work == "Pride and Prejudice",
         character_name %in% c("Elizabeth Bennet", "Jane Bennet", "Lydia Bennet",
                               "Mr. Darcy", "Mr. William Collins", "George Wickham")) %>%
  group_by(character_name) %>%
  top_n(8, abs(mean)) %>%
  ungroup() %>%
  mutate(spectrum_label = ifelse(mean > 0, spectrum_high, spectrum_low),
         mean = abs(mean),
         spectrum_label = reorder_within(spectrum_label, mean, character_name))

pride_example %>%
  ggplot() +
  geom_col(aes(mean, spectrum_label, fill = character_name), show.legend = FALSE) +
  geom_vline(xintercept = seq(0, 50, by = 10), colour = "#FFF1E6", size = 0.1) +
  scale_y_reordered() +
  scale_fill_manual(values = pride_palette) +
  expand_limits(x = c(0, 50)) +
  facet_wrap(~ character_name, scales = "free_y") +
  labs(title = "Pride and Prejudice",
       x = "Score (out of 50)",
       y = "Personality Trait") +
  theme(plot.title = element_text(family = "JaneAusten", face = "bold", size = 32,
                                  hjust = 0.5, margin = margin(t = 10, b = 20)),
        plot.background = element_rect(fill = "#FFF1E6"),
        plot.margin = margin(10, 10, 10, 10),
        strip.text = element_text(family = "JaneAusten", size = 18, margin = margin(b = 10)),
        axis.text.x = element_text(family = "Sylfaen", size = 14, hjust = 0.5),
        axis.text.y = element_text(family = "Sylfaen", size = 14, hjust = 1))
```  
\  

Some of the traits are harder to interpret, like Elizabeth Bennet's top trait, "treasure". These make more sense when you see its twin on the other end of the spectrum. (In this case, it's "treasure" on one end and "trash" on the other.)

The traits for the rest of the characters are spot-on: **selfish** George Wickham, **kind** Jane, **foolish** Lydia, **rich** and **reserved** Mr. Darcy, and **awkward** Mr. Collins.  
\  


#### *The Lion King*

```{r lion-king-example, fig.align = 'center', fig.width = 12, fig.height = 6.75}
lion_king_palette <- c("#FFBA08", "#FCA311", "#E85D04",
                       "#DC2F02", "#791901", "#38160D")

lion_king_example <- personalities %>%
  filter(!is_emoji,
         fictional_work == "The Lion King") %>%
  group_by(character_name) %>%
  top_n(8, abs(mean)) %>%
  ungroup() %>%
  mutate(spectrum_label = ifelse(mean > 0, spectrum_high, spectrum_low),
         mean = abs(mean),
         spectrum_label = reorder_within(spectrum_label, mean, character_name))

lion_king_example %>%
  ggplot() +
  geom_col(aes(mean, spectrum_label, fill = character_name), show.legend = FALSE) +
  geom_vline(xintercept = seq(0, 50, by = 10), colour = "#FFFBEB", size = 0.1) +
  scale_y_reordered() +
  scale_fill_manual(values = lion_king_palette) +
  expand_limits(x = c(0, 50)) +
  facet_wrap(~ character_name, scales = "free_y") +
  labs(title = "The Lion King",
       x = "Score (out of 50)",
       y = "Personality Trait") +
  theme(plot.title = element_text(family = "African", size = 32, hjust = 0.5, margin = margin(t = 10, b = 20)),
        plot.background = element_rect(fill = "#FFFBEB"),
        plot.margin = margin(10, 10, 10, 10),
        strip.text = element_text(family = "African", size = 18, margin = margin(b = 10)),
        axis.text.x = element_text(family = "IBM Plex Sans", size = 14, hjust = 0.5),
        axis.text.y = element_text(family = "IBM Plex Sans", size = 14, hjust = 1))
```  
\  

Scar has lots of great traits for a villain (including the very on-the-nose **villainous**!). Timon is **thin** and Pumbaa is **thick**. Nala's top trait is **beautiful**, which I find a bit weird for an animated lion.  
\  


### Helper Datasets

```{r helper-datasets}
character_list <- personalities %>%
  distinct(character_code, fictional_work, character_name)

spectrum_list <- personalities %>%
  distinct(spectrum, spectrum_low, spectrum_high)

interesting_works <- c("Arrested Development", "Brooklyn Nine-Nine", "Star Trek: Deep Space Nine",
                       "Friends", "Game of Thrones", "The Good Place", "Harry Potter",
                       "The Lion King", "Mad Men", "Parks and Recreation", "Seinfeld",
                       "Silicon Valley", "Star Wars", "Star Trek: The Next Generation",
                       "Pride and Prejudice", "Community", "Schitt's Creek")
```


### Principal Component Analysis (PCA)

We'll use `tidymodels` to conduct PCA.

- `tidymodels` documentation: https://recipes.tidymodels.org/reference/step_pca.html
- Julia Silge's walkthrough: https://juliasilge.com/blog/best-hip-hop/

Convert data to a wide format, with rows for characters and columns for personality spectrums

```{r data-for-pca}
pca_data <- personalities %>%
  filter(!is_emoji) %>%
  select(character_code, spectrum, mean) %>%
  pivot_wider(names_from = spectrum, values_from = mean)

pca_data %>%
  head(6) %>%
  select(1:5) %>%
  kable(format = "html") %>%
  kable_styling()
```



```{r initial-pca}
# Write recipe for PCA
pca_recipe <- recipe(~ ., data = pca_data) %>%
  # Specify character_code as key/id column
  update_role(character_code, new_role = "id") %>%
  # Normalize sets mean to zero and standard deviation of one
  step_normalize(all_predictors()) %>%
  # PCA is done here
  step_pca(all_predictors())
```

```{r}
top_pc_palette <- c("#264653", "#2A9D8F", "#8AB17D",
                    "#E9C46A", "#F4A261", "#E76F51")

# Inspect a few principal components to see what they capture
prep(pca_recipe) %>%
  # Inspect the recipe after it has completed step 2
  tidy(type = "coef", number = 2) %>%
  # Add interpretable names of spectrums
  left_join(spectrum_list, by = c("terms" = "spectrum")) %>%
  # Take the end of the spectrum that the principal component value is closest to
  mutate(label = ifelse(value > 0, spectrum_high, spectrum_low),
         abs_value = abs(value)) %>%
  # Look at the first six components
  filter(component %in% paste0("PC", 1:6)) %>%
  # Look at the 8 strongest elements of each component
  group_by(component) %>%
  top_n(8, abs_value) %>%
  ungroup() %>%
  # Reorder spectrum labels so that they will be graphed from highest to lowest
  # reorder_within() is useful for when you want things ordered in a facetted graph
  mutate(text_label = label,
         label = reorder_within(label, by = abs_value, within = component)) %>%
  ggplot() +
  geom_col(aes(abs_value, label, fill = component),
           show.legend = FALSE) +
  geom_text(aes(x = 0, y = label, label = text_label),
            hjust = 0, nudge_x = 0.005, family = "IBM Plex Sans",
            colour = "white", size = 5, fontface = "bold") +
  scale_x_continuous(breaks = seq(0, 0.2, by = 0.05)) +
  scale_y_reordered() +
  scale_fill_manual(values = top_pc_palette) +
  facet_wrap(~ component, scales = "free_y", ncol = 2) +
  labs(title = "Top Principal Components") +
  theme(text = element_text(family = "IBM Plex Sans"),
        plot.title = element_text(size = 32, hjust = 0.5, margin = margin(t = 10, b = 20)),
        strip.text = element_text(size = 18, hjust = 0, margin = margin(0, 5, 5, 5)),
        axis.text.x = element_text(size = 14, hjust = 0.5))
```

```{r}
# Inspect PCA to see which principal components account for what % of variance
test <- prep(pca_recipe) %>%
  tidy(type = "variance", number = 2) %>%
  filter(terms == "cumulative percent variance") %>%
  mutate(pct_variance = value / 100)

test %>%
  ggplot(aes(component, pct_variance)) +
  geom_line(size = 1.5) +
  geom_ribbon(aes(ymin = min(pct_variance), ymax = pct_variance),
              alpha = 0.3) +
  scale_x_continuous(breaks = seq(0, 240, by = 20)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1),
                     labels = label_percent(accuracy = 1)) +
  coord_cartesian(ylim = c(min(test$pct_variance), 1)) +
  labs(title = "Cumulative Variance Explained",
       x = "Number of Principal Components",
       y = "Percent of Variance Explained") +
  theme_light()
```



```{r pca-specified-variance-threshold}
# Add threshold to PCA to cover 50% of variance
pca_recipe <- recipe(~ ., data = pca_data) %>%
  update_role(character_code, new_role = "id") %>%
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors(),
           threshold = 0.90)

# Run PCA
personality_pca <- prep(pca_recipe) %>%
  juice()

personality_pca
```

```{r pca-pair-scatterplot}
character_list %>%
  left_join(personality_pca, by = "character_code") %>%
  filter(fictional_work %in% interesting_works) %>%
  ggplot(aes(PC01, PC03)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_text(aes(label = character_name), check_overlap = TRUE) +
  expand_limits(x = c(-20, 20),
                y = c(-20, 20)) +
  theme_light()
```


### APPENDIX

```{r gender}
personalities %>%
  filter(!is_emoji,
         !is.na(gender)) %>%
  group_by(spectrum, spectrum_low, spectrum_high) %>%
  mutate(overall_avg_score = mean(mean) - 50) %>%
  ungroup() %>%
  group_by(spectrum, spectrum_low, spectrum_high, overall_avg_score, gender) %>%
  summarise(avg_score = mean(mean) - 50) %>%
  ungroup() %>%
  pivot_wider(names_from = gender, values_from = avg_score) %>%
  mutate(female = female - overall_avg_score,
         male = male - overall_avg_score) %>%
  pivot_longer(female:male, names_to = "gender", values_to = "avg_diff") %>%
  group_by(gender) %>%
  top_n(16, wt = abs(avg_diff)) %>%
  ungroup() %>%
  unite("spectrum_name", spectrum_low, spectrum_high, sep = " <---> ") %>%
  mutate(spectrum_name = reorder_within(spectrum_name, avg_diff, gender)) %>%
  ggplot(aes(avg_diff, spectrum_name, fill = gender)) +
  geom_col() +
  geom_vline(xintercept = 0) +
  scale_y_reordered() +
  facet_wrap(~ gender, scales = "free_y") +
  theme_light()
```

