---
title: "fictional-character-personalities"
author: "Alex Cookson"
date: "11/11/2020"
output: html_document
---

### Introduction

- PCA, dimensionality reduction
- Overview of data


### The Data

```{r setup, message = FALSE, warning = FALSE}
library(tidyverse) # For data manipulation
library(tidymodels) # For PCA
library(tidytext) # For reorder_within()

# These are to make tables look nice on the website
# You probably won't need them
library(knitr)
library(kableExtra)

theme_set(theme_void())

personalities <- read_tsv("~/data/fictional-character-personalities/personalities.txt")
```

### Data Inspection

```{r}
personalities %>%
  filter(character_name == "Jean-Luc Picard") %>%
  head(10) %>%
  arrange(mean) %>%
  kable(format = "html") %>%
  kable_styling()
```

Captain Picard is **refined** and **charming**, as well as **bold** and **tasteful**.



### Examples from Pride and Prejudice and The Lion King

```{r colour-palette}
custom_palette <- c("#19313b", "#3b636b", "#bbb6a2",
                    "#ffc277", "#bc652f", "#472411")
```


```{r pride-and-prejudice-example}
personalities %>%
  filter(!is_emoji,
         fictional_work == "Pride and Prejudice",
         character_name %in% c("Elizabeth Bennet", "Jane Bennet", "Lydia Bennet",
                               "Mr. Darcy", "Mr. William Collins", "George Wickham")) %>%
  mutate(mean = mean - 50) %>%
  group_by(character_name) %>%
  top_n(8, abs(mean)) %>%
  ungroup() %>%
  mutate(spectrum_label = ifelse(mean > 0, spectrum_high, spectrum_low),
         mean = abs(mean),
         spectrum_label = reorder_within(spectrum_label, mean, character_name)) %>%
  ggplot() +
  geom_col(aes(mean, spectrum_label, fill = character_name), show.legend = FALSE) +
  geom_vline(xintercept = seq(0, 50, by = 10), colour = "white", size = 0.1) +
  scale_y_reordered() +
  scale_fill_manual(values = custom_palette) +
  expand_limits(x = c(0, 50)) +
  facet_wrap(~ character_name, scales = "free_y") +
  labs(title = "Pride and Prejudice",
       x = "Score (out of 50)",
       y = "Personality Trait") +
  theme(plot.title = element_text(size = 20, hjust = 0.5, margin = margin(t = 10, b = 20)),
        axis.text.x = element_text(size = 12, hjust = 0.5),
        axis.text.y = element_text(size = 12, hjust = 1),
        strip.text = element_text(size = 14, face = "bold", margin = margin(b = 5)))
```

```{r lion-king-example}
personalities %>%
  filter(!is_emoji,
         fictional_work == "The Lion King") %>%
  mutate(mean = mean - 50) %>%
  group_by(character_name) %>%
  top_n(8, abs(mean)) %>%
  ungroup() %>%
  mutate(spectrum_label = ifelse(mean > 0, spectrum_high, spectrum_low),
         mean = abs(mean),
         spectrum_label = reorder_within(spectrum_label, mean, character_name)) %>%
  ggplot() +
  geom_col(aes(mean, spectrum_label, fill = character_name), show.legend = FALSE) +
  scale_y_reordered() +
  facet_wrap(~ character_name, scales = "free_y") +
  labs(title = "The Lion King",
       x = "Score (out of 50)",
       y = "Personality Trait")
```


### Helper Datasets

```{r helper-datasets}
character_list <- personalities %>%
  distinct(character_code, fictional_work, character_name)

spectrum_list <- personalities %>%
  distinct(spectrum, spectrum_low, spectrum_high)

interesting_works <- c("Arrested Development", "Anna Karenina", "Brooklyn Nine-Nine", "Star Trek: Deep Space Nine", "Friends",
                       "Game of Thrones", "The Good Place", "Harry Potter", "The Lion King", "Mad Men", "Parks and Recreation",
                       "Seinfeld", "Silicon Valley", "Star Wars", "Star Trek: The Next Generation", "Pride and Prejudice")
```


### Use `tidymodels` to implement Principal Component Analysis (PCA)

Resources for PCA:

- `tidymodels` documentation: https://recipes.tidymodels.org/reference/step_pca.html
- Julia Silge's walkthrough: https://juliasilge.com/blog/best-hip-hop/

Convert data to a wide format, with rows for characters and columns for personality spectrums

```{r data-for-pca}
pca_data <- personalities %>%
  filter(!is_emoji) %>%
  select(character_code, spectrum, mean) %>%
  pivot_wider(names_from = spectrum, values_from = mean)

pca_data %>%
  slice(100:105) %>%
  select(1:5) %>%
  kable(format = "html") %>%
  kable_styling()
```



```{r initial-pca}
# Write recipe for PCA
pca_recipe <- recipe(~ ., data = pca_data) %>%
  update_role(character_code, new_role = "id") %>%
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors())
```

```{r}
# Inspect a few principal components to see what they capture
prep(pca_recipe) %>%
  tidy(type = "coef", number = 2) %>%
  left_join(spectrum_list, by = c("terms" = "spectrum")) %>%
  mutate(label = ifelse(value > 0, spectrum_high, spectrum_low),
         abs_value = abs(value)) %>%
  filter(component %in% paste0("PC", 1:6)) %>%
  group_by(component) %>%
  top_n(12, abs_value) %>%
  ungroup() %>%
  mutate(label = reorder_within(label, by = abs_value, within = component)) %>%
  ggplot(aes(abs_value, label)) +
  geom_col() +
  scale_y_reordered() +
  facet_wrap(~ component, scales = "free_y", ncol = 2)
```

```{r}
# Inspect PCA to see which principal components account for what % of variance
test <- prep(pca_recipe) %>%
  tidy(type = "variance", number = 2) %>%
  filter(terms == "cumulative percent variance") %>%
  mutate(pct_variance = value / 100)

test %>%
  ggplot(aes(component, pct_variance)) +
  geom_line(size = 1.5) +
  geom_ribbon(aes(ymin = min(pct_variance), ymax = pct_variance),
              alpha = 0.3) +
  scale_x_continuous(breaks = seq(0, 240, by = 20)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1),
                     labels = label_percent(accuracy = 1)) +
  coord_cartesian(ylim = c(min(test$pct_variance), 1)) +
  labs(title = "Cumulative Variance Explained",
       x = "Number of Principal Components",
       y = "Percent of Variance Explained")
```



```{r pca-specified-variance-threshold}
# Add threshold to PCA to cover 50% of variance
pca_recipe <- recipe(~ ., data = pca_data) %>%
  update_role(character_code, new_role = "id") %>%
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors(),
           threshold = 0.75)

# Run PCA
personality_pca <- prep(pca_recipe) %>%
  juice()

personality_pca
```

```{r pca-pair-scatterplot}
character_list %>%
  left_join(personality_pca, by = "character_code") %>%
  filter(fictional_work %in% interesting_works) %>%
  ggplot(aes(PC01, PC03)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_text(aes(label = character_name), check_overlap = TRUE) +
  expand_limits(x = c(-20, 20),
                y = c(-20, 20))
```
