---
title: "What do countries' diplomatic gifts tell us about them?"
description: "Text analysis of diplomatic gifts to U.S. federal employees"
author: "Alex Cookson"
date: "2020-05-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup-and-import}
library(tidyverse)
library(tidytext)
library(scales)
library(fishualize)

theme_set(theme_light())

gifts <- read_csv("https://raw.githubusercontent.com/tacookson/data/master/us-government-gifts/gifts.csv")

source("https://raw.githubusercontent.com/tacookson/data/master/us-government-gifts/src/country-adjective-list.R")
```


```{r stop-words}
gift_stop_words <- c("x", # Used for describing dimensions
                     "inches",
                     "est", # Common words about value and disposition
                     "rec'd",
                     "recd",
                     "disposition",
                     "administration",
                     "services",
                     "pending",
                     "transfer",
                     "transferred",
                     "archives",
                     "protocol",
                     "gsa",
                     "national",
                     "foreign",
                     "records",
                     "de", # Stop word in romance languages like French/Spanish
                     "la",
                     "los")

month_stop_words <- str_to_lower(c(month.abb, month.name))

custom_stop_words <- tibble(stop_word = c(country_stop_words, gift_stop_words, month_stop_words)) %>%
  unnest_tokens(word, stop_word)
```

```{r gift-tokens}
gift_words <- gifts %>%
  # Select unique gift descriptions to pare down gifts that often take up multiple lines
  distinct(gift_description, .keep_all = TRUE) %>%
  transmute(id,
            donor_country,
            gift_description = str_to_lower(gift_description)) %>%
  # Filter out travel
  filter(!str_detect(gift_description, "travel")) %>%
  # Break gift_description into individual words
  unnest_tokens(word, gift_description) %>%
  # Get rid of standard English stop words (or, the, an, etc.)
  anti_join(stop_words, by = "word") %>%
  # Get rid of our custom stop words
  anti_join(custom_stop_words, by = "word") %>%
  # Only keep words that have at least one letter
  # Numbers only aren't likely meaningful in our context
  filter(str_detect(word, "[a-z]"),
         !is.na(donor_country))
```


```{r interesting-countries}
g7_countries <- c("Italy", "Japan", "Germany", "Canada", "United Kingdom", "France")

g20_countries <- c("Argentina", "Australia", "Brazil", "Canada", "China", "France", "Germany",
                   "India", "Indonesia", "Italy", "Japan", "Mexico", "Russia", "Saudi Arabia",
                   "South Africa", "South Korea", "Turkey", "United Kingdom")
```

```{r tf-idf}
gift_words_tfidf <- gift_words %>%
  distinct(id, donor_country, word) %>%
  count(word, donor_country) %>%
  bind_tf_idf(word, donor_country, n) %>%
  # Only include words that appears in at least 3 gift descriptions
  filter(n >= 3)
```

```{r g7-countries-tf-idf}
gift_words_tfidf %>%
  filter(donor_country %in% g7_countries) %>%
  group_by(donor_country) %>%
  top_n(6) %>%
  ungroup() %>%
  mutate(word = reorder_within(word, by = tf_idf, within = donor_country, sep = ": ")) %>%
  ggplot(aes(tf_idf, word, fill = donor_country)) +
  geom_col() +
  scale_y_reordered(sep = ": ") +
  scale_fill_fish(option = "Epibulus_insidiator", discrete = TRUE) +
  facet_wrap(~ donor_country, scales = "free_y") +
  labs(title = "What words are associated with different countries' diplomatic gifts to the U.S.?") +
  theme(legend.position = "none",
        axis.text.y = element_text(size = 14),
        strip.background = element_blank(),
        strip.text = element_text(colour = "black", face = "bold"))
```

Discuss shortcoming of TF-IDF approach:

- You might get words that aren't meaningful to answering your question (e.g., Moscow, Kremlin for Russia)
- Tokenizing by individual words ignores significance of compound nouns (e.g., mother-of-pearl for South Korea, leather briefcase for Argentina)
- Words used in one or two "documents" can have large TF-IDF, which can be misleading. We filtered for words that appear in at least three gift descriptions to address this, but adding that filter has its own issues because we set an arbitrary threshold and might be losing out on interesting information in words that do appear in only 1 or 2 descriptions.

```{r g20-countries-tf-idf}
gift_words_tfidf %>%
  filter(donor_country %in% setdiff(g20_countries, g7_countries)) %>%
  group_by(donor_country) %>%
  top_n(6) %>%
  ungroup() %>%
  mutate(word = reorder_within(word, by = tf_idf, within = donor_country, sep = ": ")) %>%
  ggplot(aes(tf_idf, word, fill = donor_country)) +
  geom_col() +
  scale_y_reordered(sep = ": ") +
  scale_fill_fish(option = "Epibulus_insidiator", discrete = TRUE) +
  facet_wrap(~ donor_country, scales = "free_y") +
  labs(title = "What words are associated with different countries' diplomatic gifts to the U.S.?") +
  theme(legend.position = "none",
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(size = 14),
        strip.background = element_blank(),
        strip.text = element_text(colour = "black", face = "bold"))
```

```{r top-tf-idf-overall}
gift_words_tfidf %>%
  top_n(16, wt = tf_idf) %>%
  mutate(word = fct_reorder(str_to_title(word), tf_idf)) %>%
  ggplot(aes(tf_idf, word, fill = donor_country)) +
  geom_col() +
  geom_text(aes(label = donor_country),
            col = "white",
            fontface = "bold",
            hjust = 1,
            nudge_x = -0.005) +
  scale_fill_fish("Epibulus_insidiator", discrete = TRUE) +
  scale_colour_fish("Epibulus_insidiator", discrete = TRUE) +
  expand_limits(x = c(0, 0.45)) +
  labs(title = "What are the most \"distinctive\" words associated with diplomatic gifts?",
       x = "TF-IDF",
       y = NULL) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(size = 14),
        strip.background = element_blank(),
        strip.text = element_text(colour = "black", face = "bold"))
```

Annotation notes for above:

- Iceland likes giving the book "The Complete Sagas of Icelanders" (id 762, 7026, 7790)
- Luxembourg likes giving fox sculptures (id 2123, 2239, 2678)
- Ghana likes giving Kente cloth gifts, which is a traditional cloth of Ghana (id 880, 2527, 8361)
- Moldova likes giving cognax (id 5932, 8293)
- Cuba likes giving cigars (id 568, 7152, 6959)
- Sweden likes giving Orrefors crystal (id 654, 1742, 6195)


```{r gift-description-lookup}
gifts %>%
  filter(donor_country == "Argentina",
         str_detect(str_to_lower(gift_description), "briefcase")) %>%
  View()
```










### Appendix

Questions:

- What are the most and least expensive gifts?
- Do some countries give more expensive gifts than others?
- How many of these gifts are given specifically to the President? (And what is their value?)
- What gifts has Canada given?
- Do certain countries give certain types of gifts?


Additional areas to explore:

- Looking at named entities instead of single words (would probably capture things like "men's watch" instead of separating the words)



### Unused code

```{r recipients, eval = FALSE}
gift_words_by_person <- gifts %>%
  # Select unique gift descriptions to pare down travel "gifts" that often take up multiple lines
  distinct(gift_description, .keep_all = TRUE) %>%
  # Filter out travel
  filter(!str_detect(str_to_lower(gift_description), "travel")) %>%
  transmute(id,
            recipient,
            gift_description = str_to_lower(gift_description)) %>%
  unnest_tokens(word, gift_description) %>%
  anti_join(stop_words, by = "word") %>%
  anti_join(custom_stop_words, by = "word") %>%
  filter(str_detect(word, "[a-z]"),
         !is.na(recipient))

gift_words_by_person %>%
  distinct(id, recipient, word) %>%
  count(word, recipient) %>%
  bind_tf_idf(word, recipient, n) %>%
  filter(n >= 3) %>%
  arrange(desc(tf_idf)) %>%
  filter(str_detect(recipient, c("President")),
         !str_detect(recipient, "Vice"),
         !str_detect(recipient, "Assistant")) %>%
  group_by(recipient) %>%
  top_n(6) %>%
  ungroup() %>%
  mutate(word = reorder_within(word, by = tf_idf, within = recipient, sep = ": ")) %>%
  ggplot(aes(tf_idf, word, fill = recipient)) +
  geom_col() +
  scale_y_reordered(sep = ": ") +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE) +
  facet_wrap(~ recipient, scales = "free_y") +
  labs(title = "What words are associated with different countries' diplomatic gifts to the U.S.?") +
  theme(legend.position = "none",
        axis.text.y = element_text(size = 14),
        strip.background = element_blank(),
        strip.text = element_text(colour = "black", face = "bold"))
```

```{r president-gift-words, eval = FALSE}
gift_words_by_person %>%
  filter(str_detect(recipient, "^President") | str_detect(recipient, "President of the United States")) %>%
  count(word, sort = TRUE) %>%
  top_n(20, wt = n) %>%
  mutate(word = fct_reorder(word, n)) %>%
  ggplot(aes(n, word, fill = word)) +
  geom_col() +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE,
                  direction = -1) +
  theme(legend.position = "none")
```

```{r gift-value-by-country, eval = FALSE}
top_20_countries <- gifts %>%
  group_by(donor_country) %>%
  summarise(value_usd = sum(value_usd, na.rm = TRUE)) %>%
  filter(!is.na(donor_country)) %>%
  top_n(20, wt = value_usd) %>%
  pull(donor_country)

gifts %>%
  group_by(donor_country) %>%
  summarise(value_usd = sum(value_usd, na.rm = TRUE)) %>%
  filter(!is.na(donor_country)) %>%
  top_n(20, wt = value_usd) %>%
  mutate(donor_country = fct_reorder(donor_country, value_usd)) %>%
  ggplot(aes(value_usd, donor_country, fill = donor_country)) +
  geom_col() +
  scale_x_continuous(labels = label_dollar()) +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE) +
  theme(legend.position = "none")

gifts %>%
  filter(donor_country %in% top_20_countries,
         !is.na(value_usd)) %>%
  mutate(donor_country = fct_reorder(donor_country, value_usd, median)) %>%
  ggplot(aes(value_usd, donor_country, fill = donor_country)) +
  geom_boxplot() +
  scale_x_log10(labels = label_dollar()) +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE) +
  theme(legend.position = "none")
```

```{r top-country-words, eval = FALSE}
gift_words %>%
  distinct(id, donor_country, word) %>%
  count(word, donor_country) %>%
  bind_tf_idf(word, donor_country, n) %>%
  filter(n >= 3) %>%
  arrange(desc(tf_idf)) %>%
  group_by(donor_country) %>%
  top_n(1) %>%
  ungroup() %>%
  View()
```