---
title: "U.S. Government Gifts"
author: "Alex Cookson"
date: "2020-05-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup-and-import}
library(tidyverse)
library(tidytext)
library(scales)
library(fishualize)

theme_set(theme_light())

gifts <- read_csv("https://raw.githubusercontent.com/tacookson/data/master/us-government-gifts/gifts.csv")

source("https://raw.githubusercontent.com/tacookson/data/master/us-government-gifts/src/country-adjective-list.R")
```


```{r}
gift_stop_words <- c("x", # Used for describing dimensions
                     "inches",
                     "est", # Common words about value and disposition
                     "rec'd",
                     "recd",
                     "disposition",
                     "administration",
                     "services",
                     "pending",
                     "transfer",
                     "archives",
                     "protocol",
                     "gsa",
                     "national",
                     "records",
                     "de", # Stop word in romance languages like French
                     "la",
                     "los",
                     "foreign")

month_stop_words <- str_to_lower(c(month.abb, month.name))

custom_stop_words <- tibble(stop_word = c(country_stop_words, gift_stop_words, month_stop_words)) %>%
  unnest_tokens(word, stop_word)

gift_words <- gifts %>%
  # Select unique gift descriptions to pare down travel "gifts" that often take up multiple lines
  distinct(gift_description, .keep_all = TRUE) %>%
  # Filter out travel
  filter(!str_detect(str_to_lower(gift_description), "travel")) %>%
  transmute(id,
            donor_country,
            gift_description = str_to_lower(gift_description)) %>%
  unnest_tokens(word, gift_description) %>%
  anti_join(stop_words, by = "word") %>%
  anti_join(custom_stop_words, by = "word") %>%
  filter(str_detect(word, "[a-z]"),
         !is.na(donor_country))
```

```{r}
interesting_countries <- gift_words %>%
  distinct(id, donor_country) %>%
  count(donor_country, sort = TRUE) %>%
  top_n(16, wt = n) %>%
  pull(donor_country)

gift_words_tfidf <- gift_words %>%
  distinct(id, donor_country, word) %>%
  count(word, donor_country) %>%
  bind_tf_idf(word, donor_country, n) %>%
  # Only include words that appears in at least 3 gift descriptions
  filter(n >= 3)

# Top TF-IDF words facetted by country
gift_words_tfidf %>%
  filter(donor_country %in% c("Canada", "Mexico", "United Kingdom", "France", "Germany", "Saudi Arabia", "Australia", "Russia")) %>%
  group_by(donor_country) %>%
  top_n(6) %>%
  ungroup() %>%
  mutate(word = reorder_within(word, by = tf_idf, within = donor_country, sep = ": ")) %>%
  ggplot(aes(tf_idf, word, fill = donor_country)) +
  geom_col() +
  scale_y_reordered(sep = ": ") +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE) +
  facet_wrap(~ donor_country, scales = "free_y") +
  labs(title = "What words are associated with different countries' diplomatic gifts to the U.S.?") +
  theme(legend.position = "none",
        axis.text.y = element_text(size = 14),
        strip.background = element_blank(),
        strip.text = element_text(colour = "black", face = "bold"))

# Top TF-IDF words overall
gift_words_tfidf %>%
  top_n(16, wt = tf_idf) %>%
  mutate(word = fct_reorder(str_to_title(word), tf_idf)) %>%
  ggplot(aes(tf_idf, word, fill = donor_country)) +
  geom_col() +
  geom_text(aes(label = donor_country), col = "white", hjust = 1, nudge_x = -0.005, fontface = "bold") +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE) +
  scale_colour_fish(option = "Epibulus_insidiator",
                  discrete = TRUE) +
  expand_limits(x = c(0, 0),
                y = c(0, 0)) +
  labs(title = "What are the most \"distinctive\" words associated with diplomatic gifts?",
       x = "TF-IDF",
       y = "") +
  theme(legend.position = "none",
        axis.text.y = element_text(size = 14),
        strip.background = element_blank(),
        strip.text = element_text(colour = "black", face = "bold"))
```

```{r top-country-words}
gift_words %>%
  distinct(id, donor_country, word) %>%
  count(word, donor_country) %>%
  bind_tf_idf(word, donor_country, n) %>%
  filter(n >= 3) %>%
  arrange(desc(tf_idf)) %>%
  group_by(donor_country) %>%
  top_n(1) %>%
  ungroup() %>%
  View()
```

```{r}
gifts %>%
  filter(donor_country == "United Kingdom",
         str_detect(str_to_lower(gift_description), "highness")) %>%
  View()
```



```{r gift-value-by-country}
top_20_countries <- gifts %>%
  group_by(donor_country) %>%
  summarise(value_usd = sum(value_usd, na.rm = TRUE)) %>%
  filter(!is.na(donor_country)) %>%
  top_n(20, wt = value_usd) %>%
  pull(donor_country)

gifts %>%
  group_by(donor_country) %>%
  summarise(value_usd = sum(value_usd, na.rm = TRUE)) %>%
  filter(!is.na(donor_country)) %>%
  top_n(20, wt = value_usd) %>%
  mutate(donor_country = fct_reorder(donor_country, value_usd)) %>%
  ggplot(aes(value_usd, donor_country, fill = donor_country)) +
  geom_col() +
  scale_x_continuous(labels = label_dollar()) +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE) +
  theme(legend.position = "none")

gifts %>%
  filter(donor_country %in% top_20_countries,
         !is.na(value_usd)) %>%
  mutate(donor_country = fct_reorder(donor_country, value_usd, median)) %>%
  ggplot(aes(value_usd, donor_country, fill = donor_country)) +
  geom_boxplot() +
  scale_x_log10(labels = label_dollar()) +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE) +
  theme(legend.position = "none")
```






### Appendix

Questions:

- What are the most and least expensive gifts?
- Do some countries give more expensive gifts than others?
- How many of these gifts are given specifically to the President? (And what is their value?)
- What gifts has Canada given?
- Do certain countries give certain types of gifts?


Additional areas to explore:

- Looking at named entities instead of single words (would probably capture things like "men's watch" instead of separating the words)



### Unused code

```{r recipients, eval = FALSE}
gift_words_by_person <- gifts %>%
  # Select unique gift descriptions to pare down travel "gifts" that often take up multiple lines
  distinct(gift_description, .keep_all = TRUE) %>%
  # Filter out travel
  filter(!str_detect(str_to_lower(gift_description), "travel")) %>%
  transmute(id,
            recipient,
            gift_description = str_to_lower(gift_description)) %>%
  unnest_tokens(word, gift_description) %>%
  anti_join(stop_words, by = "word") %>%
  anti_join(custom_stop_words, by = "word") %>%
  filter(str_detect(word, "[a-z]"),
         !is.na(recipient))

gift_words_by_person %>%
  distinct(id, recipient, word) %>%
  count(word, recipient) %>%
  bind_tf_idf(word, recipient, n) %>%
  filter(n >= 3) %>%
  arrange(desc(tf_idf)) %>%
  filter(str_detect(recipient, c("President")),
         !str_detect(recipient, "Vice"),
         !str_detect(recipient, "Assistant")) %>%
  group_by(recipient) %>%
  top_n(6) %>%
  ungroup() %>%
  mutate(word = reorder_within(word, by = tf_idf, within = recipient, sep = ": ")) %>%
  ggplot(aes(tf_idf, word, fill = recipient)) +
  geom_col() +
  scale_y_reordered(sep = ": ") +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE) +
  facet_wrap(~ recipient, scales = "free_y") +
  labs(title = "What words are associated with different countries' diplomatic gifts to the U.S.?") +
  theme(legend.position = "none",
        axis.text.y = element_text(size = 14),
        strip.background = element_blank(),
        strip.text = element_text(colour = "black", face = "bold"))
```

```{r president-gift-words, eval = FALSE}
gift_words_by_person %>%
  filter(str_detect(recipient, "^President") | str_detect(recipient, "President of the United States")) %>%
  count(word, sort = TRUE) %>%
  top_n(20, wt = n) %>%
  mutate(word = fct_reorder(word, n)) %>%
  ggplot(aes(n, word, fill = word)) +
  geom_col() +
  scale_fill_fish(option = "Epibulus_insidiator",
                  discrete = TRUE,
                  direction = -1) +
  theme(legend.position = "none")
```